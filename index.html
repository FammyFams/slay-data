<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Run Stats Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 1000px;
        padding: 1rem;
      }
      input[type='file'] {
        margin-bottom: 1rem;
        display: block;
      }
      .card {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .stat-box {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 6px;
        text-align: center;
      }
      canvas {
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <h1>Run Stats Analyzer</h1>
    <p>Upload the entire run folder (with all subfolders inside).</p>
    <input
      type="file"
      id="fileInput"
      multiple
      webkitdirectory
      directory
      accept=".run"
    />

    <div id="stats" class="card" style="display: none"></div>

    <script>
      let globalRunMap = {};

      document.getElementById('fileInput').addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      async function handleFiles(fileItemsOrList) {
        globalRunMap = {};

        for (const file of fileItemsOrList) {
          const pathParts = file.webkitRelativePath.split('/');
          const folderName = pathParts.length > 1 ? pathParts[1] : 'Root';
          if (!globalRunMap[folderName]) globalRunMap[folderName] = [];
          try {
            const text = await file.text();
            const json = JSON.parse(text);
            globalRunMap[folderName].push(json);
          } catch (err) {
            console.error('Error parsing', file.name);
          }
        }

        displayStats(globalRunMap);
      }

      function displayStats(runMap) {
        const statsDiv = document.getElementById('stats');
        statsDiv.style.display = 'block';
        statsDiv.innerHTML = `<h2>Stats by Folder</h2><div class="stats-grid">`;

        for (const folder in runMap) {
          const runs = runMap[folder];

          const runCount = runs.length;
          const totalPlaytime = runs.reduce(
            (sum, r) => sum + (r.playtime || 0),
            0
          );
          const totalScore = runs.reduce((sum, r) => sum + (r.score || 0), 0);
          const totalFloors = runs.reduce(
            (sum, r) => sum + (r.floor_reached || 0),
            0
          );

          const canvasId = `chart-${folder.replace(/\W/g, '')}`;

          statsDiv.innerHTML += `
          <div class="stat-box">
            <strong>${folder}</strong><br>
            Runs: ${runCount}<br>
            Avg Playtime: ${(totalPlaytime / runCount || 0).toFixed(2)}s<br>
            Avg Score: ${(totalScore / runCount || 0).toFixed(2)}<br>
            Avg Floor: ${(totalFloors / runCount || 0).toFixed(2)}<br>
            <canvas id="${canvasId}" height="200"></canvas>
          </div>
        `;

          setTimeout(() => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const floorData = runs.map((r, i) => ({
              x: `Run ${i + 1}`,
              y: r.floor_reached || 0,
            }));

            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: floorData.map((d) => d.x),
                datasets: [
                  {
                    label: 'Floors Reached',
                    data: floorData.map((d) => d.y),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Floors',
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Run #',
                    },
                  },
                },
              },
            });
          }, 0);
        }

        statsDiv.innerHTML += `</div>`;
      }
    </script>
  </body>
</html>
